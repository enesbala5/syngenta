FROM node:22-bookworm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /frontend

COPY package.json ./

# RUN npm config set fetch-retry-maxtimeout 600000 -g

RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install

COPY . .

EXPOSE 5173

# -----------------------------------

ARG PORT
ARG DATABASE_URL
ARG RESEND_API_KEY
ARG PUBLIC_NODE_ENV
ARG PUBLIC_PAGE_URL
ARG PUBLIC_BACKEND_URL
ARG CURRENCY_API_KEY
ARG PUBLIC_UMAMI_SCRIPT
ARG PUBLIC_UMAMI_DATA_WEBSITE_ID
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET

ENV PORT=$PORT
ENV DATABASE_URL=$DATABASE_URL
ENV RESEND_API_KEY=$RESEND_API_KEY
ENV PUBLIC_NODE_ENV=$PUBLIC_NODE_ENV
ENV PUBLIC_PAGE_URL=$PUBLIC_PAGE_URL
ENV PUBLIC_BACKEND_URL=$PUBLIC_BACKEND_URL
ENV CURRENCY_API_KEY=$CURRENCY_API_KEY
ENV PUBLIC_UMAMI_SCRIPT=$PUBLIC_UMAMI_SCRIPT
ENV PUBLIC_UMAMI_DATA_WEBSITE_ID=$PUBLIC_UMAMI_DATA_WEBSITE_ID
ENV GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID
ENV GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET
ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET

# -----------------------------------

RUN pnpm run generate-types

RUN pnpx @sveltejs/kit sync

RUN pnpm config set store-dir /pnpm/store --global

CMD ["pnpm", "run", "dev"]