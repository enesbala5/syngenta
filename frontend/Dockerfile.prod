# BUILD
FROM node:22-bookworm as build

WORKDIR /frontend

RUN npm install -g pnpm

COPY package.json ./

# RUN npm config set fetch-retry-maxtimeout 600000 -g

RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install

COPY . .

EXPOSE 5173

# --------------------------
ARG PORT
ARG DATABASE_URL
ARG RESEND_API_KEY
ARG PUBLIC_NODE_ENV
ARG PUBLIC_PAGE_URL
ARG PUBLIC_BACKEND_URL
ARG CURRENCY_API_KEY
ARG PUBLIC_UMAMI_SCRIPT
ARG PUBLIC_UMAMI_DATA_WEBSITE_ID
ARG OPENAI_API_KEY
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET

ENV PORT=$PORT
ENV DATABASE_URL=$DATABASE_URL
ENV RESEND_API_KEY=$RESEND_API_KEY
ENV PUBLIC_NODE_ENV=$PUBLIC_NODE_ENV
ENV PUBLIC_PAGE_URL=$PUBLIC_PAGE_URL
ENV PUBLIC_BACKEND_URL=$PUBLIC_BACKEND_URL
ENV CURRENCY_API_KEY=$CURRENCY_API_KEY
ENV PUBLIC_UMAMI_SCRIPT=$PUBLIC_UMAMI_SCRIPT
ENV PUBLIC_UMAMI_DATA_WEBSITE_ID=$PUBLIC_UMAMI_DATA_WEBSITE_ID
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID
ENV GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET
ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
# --------------------------

RUN pnpm run generate-types

RUN pnpx @sveltejs/kit sync

# RUN node --max-old-space-size=4096 ./node_modules/.bin/tsc --noEmit

RUN npm --max-old-space-size=16384 run build

RUN pnpm prune --production

# RUN

FROM node:22-bookworm as run

# --------------------------
ARG PORT
ARG DATABASE_URL
ARG RESEND_API_KEY
ARG PUBLIC_NODE_ENV
ARG PUBLIC_PAGE_URL
ARG PUBLIC_BACKEND_URL
ARG CURRENCY_API_KEY
ARG PUBLIC_UMAMI_SCRIPT
ARG PUBLIC_UMAMI_DATA_WEBSITE_ID
ARG OPENAI_API_KEY
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET

ENV PORT=$PORT
ENV DATABASE_URL=$DATABASE_URL
ENV RESEND_API_KEY=$RESEND_API_KEY
ENV PUBLIC_NODE_ENV=$PUBLIC_NODE_ENV
ENV PUBLIC_PAGE_URL=$PUBLIC_PAGE_URL
ENV PUBLIC_BACKEND_URL=$PUBLIC_BACKEND_URL
ENV CURRENCY_API_KEY=$CURRENCY_API_KEY
ENV PUBLIC_UMAMI_SCRIPT=$PUBLIC_UMAMI_SCRIPT
ENV PUBLIC_UMAMI_DATA_WEBSITE_ID=$PUBLIC_UMAMI_DATA_WEBSITE_ID
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV GITHUB_CLIENT_ID=$GITHUB_CLIENT_ID
ENV GITHUB_CLIENT_SECRET=$GITHUB_CLIENT_SECRET
ENV GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
ENV GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
# --------------------------

WORKDIR /frontend
COPY --from=build /frontend/build ./build
COPY --from=build /frontend/package.json ./package.json
COPY --from=build /frontend/node_modules ./node_modules
RUN ulimit -c unlimited

ENTRYPOINT ["node", "--max-old-space-size=8192", "build"]